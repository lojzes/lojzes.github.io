import{_ as s,X as p,Y as t,Z as a,a1 as e,$ as o,a2 as c,C as l}from"./framework-0b23a550.js";const u={},i={class:"hint-container tip"},r=a("p",{class:"hint-container-title"},"参考",-1),k={href:"https://blog.51cto.com/u_14490033/3132725",target:"_blank",rel:"noopener noreferrer"},d=c(`<h2 id="问题发现" tabindex="-1"><a class="header-anchor" href="#问题发现" aria-hidden="true">#</a> 问题发现</h2><p>本文整理自一个真实的案例，是楼主负责的业务，在一次大促之前的压测时发现了这个问题。</p><p>在每次大促之前，我们的测试人员都会对网站进行压力测试，这个时候会查看服务的cpu、内存、load、rt、qps等指标。</p><p>在一次压测过程中，测试人员发现我们的某一个接口，在qps上升到500以后，CPU使用率急剧升高。</p><h2 id="定位进程" tabindex="-1"><a class="header-anchor" href="#定位进程" aria-hidden="true">#</a> 定位进程</h2><p>登录服务器，执行 top 命令，查看 CPU 占用情况</p><p>过以上命令，我们可以看到，进程ID为 1893 的Java进程的CPU占用率达到了<code>181%</code>，基本可以定位到是我们的Java应用导致整个服务器的CPU占用率飙升。</p><h2 id="定位线程" tabindex="-1"><a class="header-anchor" href="#定位线程" aria-hidden="true">#</a> 定位线程</h2><p>我们知道，Java是单进程多线程的，那么，我们接下来看看PID=1893 的这个Java进程中的各个线程的CPU使用情况，同样是用top命令：</p><p>top -Hp 1893</p><blockquote><p>-H 显示线程信息 -p指定pid</p></blockquote><p>通过top -Hp 1893命令，我们可以发现，当前1893这个进程中，ID为4519的线程占用CPU最高。</p><h2 id="定位代码" tabindex="-1"><a class="header-anchor" href="#定位代码" aria-hidden="true">#</a> 定位代码</h2><p>首先，我们需要把 4519 这个线程转成16进制：</p><p><code>printf &#39;%xn&#39; 4519</code></p><p>11a7</p><p>jstack 1893 |grep -A 200 11a7</p><p>或者把 进程为 的线程占输出到一个文件内，通过16进制线程id查询</p><p>jstack -l \`\`1893<code></code>&gt; jstack.log</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">HSFBizProcessor</span><span class="token operator">-</span><span class="token constant">DEFAULT</span><span class="token operator">-</span><span class="token number">8</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">5</span>&quot; #<span class="token number">500</span> daemon prio<span class="token operator">=</span><span class="token number">10</span> os_prio<span class="token operator">=</span><span class="token number">0</span> tid<span class="token operator">=</span><span class="token number">0x00007f632314a800</span> nid<span class="token operator">=</span><span class="token number">0x11a2</span> runnable <span class="token punctuation">[</span><span class="token number">0x000000005442a000</span><span class="token punctuation">]</span>
   <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread<span class="token punctuation">.</span>State</span><span class="token operator">:</span> <span class="token constant">RUNNABLE</span>
  at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>URLClassPath</span>$<span class="token class-name">Loader</span><span class="token punctuation">.</span><span class="token function">findResource</span><span class="token punctuation">(</span><span class="token class-name">URLClassPath</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">684</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>URLClassPath</span><span class="token punctuation">.</span><span class="token function">findResource</span><span class="token punctuation">(</span><span class="token class-name">URLClassPath</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">188</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span>$<span class="token number">2.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">URLClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">569</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span>$<span class="token number">2.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">URLClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">567</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token class-name">Native</span> <span class="token class-name">Method</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span><span class="token punctuation">.</span><span class="token function">findResource</span><span class="token punctuation">(</span><span class="token class-name">URLClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">566</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1093</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URLClassLoader</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token class-name">URLClassLoader</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">232</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span>ValidationXmlParser</span><span class="token punctuation">.</span><span class="token function">getInputStreamForPath</span><span class="token punctuation">(</span><span class="token class-name">ValidationXmlParser</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">248</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span>ValidationXmlParser</span><span class="token punctuation">.</span><span class="token function">getValidationConfig</span><span class="token punctuation">(</span><span class="token class-name">ValidationXmlParser</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">191</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>xml<span class="token punctuation">.</span></span>ValidationXmlParser</span><span class="token punctuation">.</span><span class="token function">parseValidationXml</span><span class="token punctuation">(</span><span class="token class-name">ValidationXmlParser</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">65</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span>ConfigurationImpl</span><span class="token punctuation">.</span><span class="token function">parseValidationXml</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">287</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>hibernate<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>engine<span class="token punctuation">.</span></span>ConfigurationImpl</span><span class="token punctuation">.</span><span class="token function">buildValidatorFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">174</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>validation<span class="token punctuation">.</span></span>Validation</span><span class="token punctuation">.</span><span class="token function">buildDefaultValidatorFactory</span><span class="token punctuation">(</span><span class="token class-name">Validation</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">111</span><span class="token punctuation">)</span>
  at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>BeanValidator</span><span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name">BeanValidator</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">)</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="问题解决" tabindex="-1"><a class="header-anchor" href="#问题解决" aria-hidden="true">#</a> 问题解决</h2><p>接下来就是通过查看代码来解决问题了，我们发现，我们自定义了一个<code>BeanValidator</code>，封装了<code>Hibernate</code>的V<code>alidator</code>，然后在<code>validate</code>方法中，通过<code>Validation.buildDefaultValidatorFactory().getValidator()</code>初始化一个Validator实例，通过分析发现这个实例化的过程比较耗时。</p><p>我们重构了一下代码，把 <code>Validator</code> 实例的初始化提到方法外，在类初始化的时候创建一次就解决了问题。</p>`,23);function m(v,b){const n=l("ExternalLinkIcon");return p(),t("div",null,[a("div",i,[r,a("p",null,[a("a",k,[e("线上服务器CPU占用率高如何排查定位问题？"),o(n)])])]),d])}const f=s(u,[["render",m],["__file","cpu 太高.html.vue"]]);export{f as default};
